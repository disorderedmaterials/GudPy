name: Package

runs:
  using: "composite"
  steps:

  - name: Create DMG (OSX)
    if: runner.os == 'MacOS'
    shell: bash
    run: |
      pip install dmgbuild
      VERSION=$(grep "VERSION =" gudpy.spec | sed "s/.*\"\(.*\)\"/\1/g")
      sed -i '' -e 's/VERSION/$VERSION/g' ci/settings.py
      dmgbuild -s ci/settings.py "GudPy-$VERSION" dist/GudPy-$VERSION.dmg

  - name: Upload Artifacts (OSX)
    if: runner.os == 'MacOS'
    uses: actions/upload-artifact@v3
    with:
      name: Packages
      path: |
        dist/GudPy-*.dmg
        dist/GudPy-*-OSX

  - name: Create Zip (Windows)
    if: runner.os == 'Windows'
    shell: bash
    run: |
      VERSION=$(grep "VERSION =" gudpy.spec | sed "s/.*\"\(.*\)\"/\1/g")
      7z a dist/GudPy-$VERSION-Windows.zip dist/GudPy-$VERSION/

  - name: Upload Artifacts (Windows)
    if: runner.os == 'Windows'
    uses: actions/upload-artifact@v3
    with:
      name: Packages
      path: |
        dist/GudPy-*-Windows.zip
        dist/GudPy-*-Windows.exe

  - name: Compile Singularity (Linux)
    if: runner.os == 'Linux'
    shell: bash
    run: |
      sudo apt-get update
      sudo apt-get install -y build-essential libseccomp-dev pkg-config squashfs-tools cryptsetup
      git clone https://github.com/hpcng/singularity.git $HOME/go/singularity
      cd $HOME/go/singularity
      git fetch && git checkout v3.7.2
      ./mconfig && make -C ./builddir && sudo make -C ./builddir install

  - name: Create Singularity Image (Linux)
    if: runner.os == 'Linux'
    shell: bash
    run: |
      VERSION=$(grep "VERSION =" gudpy.spec | sed "s/.*\"\(.*\)\"/\1/g")
      sudo singularity build dist/GudPy-$VERSION.sif ci/singularity/ubuntu20.04.def

  - name: Upload Artifacts (Linux)
    if: runner.os == 'Linux'
    uses: actions/upload-artifact@v3
    with:
      name: Packages
      path: |
        dist/GudPy-*.sif
        dist/GudPy-*-Linux
